name: Build and Update Manifest (GitOps)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del cÃ³digo fuente 'portfolio'
      - name: Checkout portfolio code
        uses: actions/checkout@v4

      # 2. Generar version tag tipo YYMMDD-N (N=build diario)
      - name: Generate short version tag
        id: version
        run: |
          DATE=$(date +'%y%m%d')
          COUNT=$(git rev-list --count --since="$DATE 00:00" HEAD)
          BUILD=$(printf "%02d" $COUNT)
          VERSION="$DATE-$BUILD"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Generated version: $VERSION"

      # 3. Set up Docker Buildx para soportar multiplataforma
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Login a Harbor
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: privateregistry.404lab.site
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      # 5. Build y push para ARM64 con build arg para Next.js fonts
      - name: Build and push Docker image (ARM64)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: privateregistry.404lab.site/portfolio/portfolio:${{ env.VERSION }}
          platforms: linux/arm64
          build-args: |
            NEXT_DISABLE_FONT_DOWNLOADS=1

      # 6. Checkout del repo de manifests (k8s-infra)
      - name: Checkout k8s-infra repo
        uses: actions/checkout@v4
        with:
          repository: CapitanLooK/k8s-infra
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: k8s-infra

      # 7. Actualizar el deployment.yaml con el nuevo tag
      - name: Update image in deployment.yaml
        run: |
          cd k8s-infra/portfolio
          sed -i "s|image: privateregistry.404lab.site/portfolio/portfolio:.*|image: privateregistry.404lab.site/portfolio/portfolio:${{ env.VERSION }}|" deployment.yaml

      # 8. Commit y push al repo de manifests (k8s-infra)
      - name: Commit and push to k8s-infra
        run: |
          cd k8s-infra
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add portfolio/deployment.yaml
          if ! git diff --cached --quiet; then
            git commit -m "Update portfolio image to ${{ env.VERSION }}"
            git push
          else
            echo "No changes to commit."
          fi
